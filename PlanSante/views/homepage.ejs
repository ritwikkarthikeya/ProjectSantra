<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard | Diet Plan</title>
    <link rel="stylesheet" href="/styles.css">
</head>
<body>
    <!-- Navbar -->
    <nav>
        <div class="navbar">
            <div class="navbar-brand">
                <h1>Welcome, <%= user.username %>!</h1>
            </div>
            <div class="navbar-menu">
                <input type="text" placeholder="Search..." class="search-bar">
                <button id="myPlanButton">My Plan</button>
                <a href="/logout"><button class="logout-btn">Logout</button></a>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main>
        <!-- Day Selection -->
        <section class="day-selection">
            <h3>Select the day you're on (1-30):</h3>
            <input type="number" id="dayInput" min="1" max="30" placeholder="Enter day number">
            <button id="fetchDayPlanButton">Get Diet Plan</button>
        </section>

        <!-- Diet Plan Result -->
        <section id="dietPlanResult" style="display: none;">
            <h3>Diet Plan for Day <span id="dayNumber"></span></h3>
            <form id="dietPlanForm">
                <div id="dietPlanCheckboxes">
                    <!-- Checkbox list will be dynamically populated -->
                </div>

                <!-- Additional Food Input -->
                <div class="additional-food">
                    <label for="additionalFood">Add a food item you consumed (not in the plan):</label>
                    <input 
                        type="text" 
                        id="additionalFood" 
                        name="additionalFood" 
                        placeholder="E.g., Pizza, Ice Cream">
                </div>

                <button type="button" id="submitPlan">Update Diet Plan</button>
            </form>
        </section>
    </main>

    <!-- Scripts -->
    <script>
 
 document.getElementById('fetchDayPlanButton').addEventListener('click', async () => {
    const day = document.getElementById('dayInput').value;

    // Validate day input
    if (!day || day < 1 || day > 30) {
        alert('Please enter a valid day number between 1 and 30.');
        return;
    }

    try {
        const response = await fetch(`/my-plan/day/${day}`);
        const data = await response.json();

        if (data.success) {
            // Populate Diet Plan Checkboxes
            const dietPlanCheckboxes = document.getElementById('dietPlanCheckboxes');
            dietPlanCheckboxes.innerHTML = ''; // Clear previous content
            document.getElementById('dayNumber').textContent = day;

            data.plan.forEach(item => {
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.name = 'selectedFoods';
                checkbox.value = JSON.stringify(item);
                checkbox.id = `food-${item.Food}`;
                checkbox.checked = true;

                const label = document.createElement('label');
                label.htmlFor = `food-${item.Food}`;
                label.innerHTML = `
                    <strong>${item.Food}</strong> 
                    (Calories: ${item.Calories}, Proteins: ${item.Proteins}g, Carbs: ${item.Carbs}g, Fats: ${item.Fats}g)
                `;

                const div = document.createElement('div');
                div.classList.add('food-item');
                div.appendChild(checkbox);
                div.appendChild(label);

                dietPlanCheckboxes.appendChild(div);
            });

            // Show the Diet Plan Section
            document.getElementById('dietPlanResult').style.display = 'block';
        } else {
            alert(data.message || 'Failed to fetch the diet plan.');
        }
    } catch (error) {
        console.error('Error fetching diet plan:', error);
        alert('An error occurred while fetching the diet plan.');
    }
});

// Submit Updated Diet Plan
document.getElementById('submitPlan').addEventListener('click', async () => {
    const day = document.getElementById('dayInput').value;

    // Get selected foods (checked items)
    const selectedFoods = Array.from(document.querySelectorAll('input[name="selectedFoods"]:checked'))
        .map(checkbox => JSON.parse(checkbox.value));

    // Get additional food input
    const additionalFood = document.getElementById('additionalFood').value.trim();

    try {
        const response = await fetch(`/diet-plan/adjust/${day}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ selectedFoods, additionalFood }),
        });
        const result = await response.json();

        if (result.success) {
            alert('Diet plan updated successfully!');
            console.log('Updated Diet Plan:', result.updatedPlan);
        } else {
            alert(result.message || 'Failed to update the diet plan.');
        }
    } catch (error) {
        console.error('Error updating diet plan:', error);
        alert('An error occurred while updating the diet plan.');
    }
});

// Adjust diet plan if additional food is provided
function adjustDietPlan(data, dietPlan, eatenFood) {
    const updatedDietPlan = [];

    // Loop through all the days in the diet plan
    for (let day of dietPlan) {
        const updatedDay = [];
        let foodReplaced = false;

        // Loop through each meal of the day
        for (let meal of day) {
            // Check if the meal is the one that was eaten and needs to be replaced
            if (meal.Food === eatenFood && !foodReplaced) {
                // Replace the eaten food with a random food from the provided data
                const substitute = data[Math.floor(Math.random() * data.length)];
                updatedDay.push({
                    Food: substitute.food_name,
                    Calories: substitute.energy_kcal,
                    Proteins: substitute.protein_g,
                    Carbs: substitute.carb_g,
                    Fats: substitute.fat_g,
                });
                foodReplaced = true; // Ensure only one replacement per day
            } else {
                // Keep the meal if it wasn't eaten
                updatedDay.push(meal);
            }
        }

        updatedDietPlan.push(updatedDay);
    }

    return updatedDietPlan;
}

    </script>
</body>
</html>
